// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" 
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id
  name           String
  loveName       String
  track          String
  entries        Entry[]
  sentActivities EntryActivity[] @relation("ActivityActor")
  notifications  Notification[]
  createdAt      DateTime        @default(now())
}

model Entry {
  id            String          @id @default(cuid())
  userId        String
  date          DateTime
  weekStart     DateTime
  count         Int
  note          String?
  tags          String?
  imageUrl      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  editedAt      DateTime?

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities    EntryActivity[]
  notifications Notification[]

  @@index([userId, date])
  @@index([weekStart])
}

enum EntryActivityType {
  reaction
  comment
  reply
}

enum ReactionKind {
  thumbs_up
  love
  smile
  cry
  side_eye
  kind
}

model EntryActivity {
  id              String            @id @default(cuid())
  entryId          String
  actorId          String
  type             EntryActivityType
  content          String?
  reactionKind     ReactionKind?
  parentId         String?
  targetCommentId  String?
  createdAt        DateTime          @default(now())

  entry            Entry             @relation(fields: [entryId], references: [id], onDelete: Cascade)
  actor            User              @relation("ActivityActor", fields: [actorId], references: [id], onDelete: Cascade)
  notifications    Notification[]
  parent           EntryActivity?    @relation("EntryActivityThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies          EntryActivity[]   @relation("EntryActivityThread")
  targetComment    EntryActivity?    @relation("ReactionTargetComment", fields: [targetCommentId], references: [id], onDelete: Cascade)
  commentReactions EntryActivity[]   @relation("ReactionTargetComment")

  @@index([entryId, createdAt])
  @@index([actorId, createdAt])
  @@index([parentId])
  @@index([targetCommentId])
}

model Notification {
  id         String            @id @default(cuid())
  userId     String
  actorId    String
  entryId    String
  activityId String
  type       EntryActivityType
  isRead     Boolean           @default(false)
  createdAt  DateTime          @default(now())

  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  entry      Entry             @relation(fields: [entryId], references: [id], onDelete: Cascade)
  activity   EntryActivity     @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([entryId, userId, isRead])
}